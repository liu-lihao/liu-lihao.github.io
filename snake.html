<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link href="img/favicon.ico">
	<title>贪吃蛇</title>
	<style>
		body {
			padding: 0;
			margin: 0;
			background: #005500;
		}
		.center,.right {
			position :fixed;
		}
		#map {
			background: #1A3500;
			background-size:100%;
			position: relative;
		}
		#map .scroe {
			display:block;
			height:100px;
			width: 200px;
			position: absolute;
			top: 50%;
			left : 50%;
			margin: -50px 0 0 -100px;
			color: rgb(0,100,0);
			cursor: default;
			text-align:center;
			line-height:100px;
		}
		#map .snake,#map .food {
			background: rgb(9,145,34);
			position: absolute;
			z-index: 4;
		}
		#map .snake0 {
			background: url("img/snake_header.webp");
			background-size: 100%;
		}
		#map .food {
			background: orangered;
		}
		#roulette {
			background: url("img/snake_roulette.png");
			background-size: 100%;
		}
	</style>
	<script src="js/jq.js" type="text/javascript" charset="utf-8"></script>
	<script>
		$(function(){
			function Snake() {
				var _this = this;
				_this.style_copy = $("style").html();
				_this.shuping_flag = false; //是否竖屏，竖屏的话，将内容横向。
				_this.inW,_this.inH,_this.grid = 0;
				_this.score_target = $("#map .scroe");	//修改特定class元素的html记录分数。
				_this.snake_init = function(){	//地图、轮盘、蛇重新初始化
					_this.inW = $(window).width();
					_this.inH = $(window).height();
					if(_this.inW<_this.inH){_this.shuping_flag = true;}else{_this.shuping_flag = false;}
					_this.grid = _this.shuping_flag ? parseInt(_this.inH*0.76/30) : parseInt(_this.inW*0.76/30);
					$("style").html( _this.style_copy + "#map .snake,#map .food{width: " + _this.grid + "px;height: " + _this.grid +"px;border-radius : " +_this.grid/2+ "px}");
					$("#map").css({
						width : _this.shuping_flag ? parseInt(_this.inH/_this.grid*0.76*0.67)*_this.grid: parseInt(_this.inW/_this.grid*0.76)*_this.grid,
						height : _this.shuping_flag ? parseInt(_this.inH/_this.grid*0.76)*_this.grid: parseInt(_this.inW/_this.grid*0.76*0.67)*_this.grid,
						marginTop: _this.shuping_flag ? -parseInt(_this.inH/_this.grid*0.76)*_this.grid/2: -parseInt(_this.inW/_this.grid*0.76*0.67)*_this.grid/2,
						marginLeft: _this.shuping_flag ? -parseInt(_this.inH/_this.grid*0.76*0.67)*_this.grid/2: -parseInt(_this.inW/_this.grid*0.76)*_this.grid/2
					});
					$("#map .scroe").css({
						fontSize: _this.shuping_flag ? _this.inW/23: _this.inH/23,
						transform: _this.shuping_flag ? "rotate(90deg)": ""
					});
					$("#roulette").css({
						width: _this.shuping_flag ? parseInt(_this.inH*0.22): parseInt(_this.inW*0.22),
						height: _this.shuping_flag ? parseInt(_this.inH*0.22): parseInt(_this.inW*0.22),
						marginTop: _this.shuping_flag ? - parseInt(_this.inH*0.22)/2: - parseInt(_this.inW*0.22)/2,
						marginLeft: _this.shuping_flag ? - parseInt(_this.inH*0.22)/2: - parseInt(_this.inW*0.22)/2,
					});
					$(".center").css({
						left : _this.shuping_flag ? "50%": "38%",
						top : _this.shuping_flag ? "38%": "50%"
					});
					$(".right").css({
						left : _this.shuping_flag ? "50%": "88%",
						top : _this.shuping_flag ? "88%": "50%"
					});
					_this.original();
				};
				_this.map_x = function(){return Math.round($("#map").width()/_this.grid)};
				_this.map_y = function(){return Math.round($("#map").height()/_this.grid)};
				_this.original = function() {	//设定初始值;
					clearInterval(_this.timer);
					_this.timer = null;
					if(_this.shuping_flag){
						_this.body = [
							{x:19,y:2},
							{x:19,y:1},
							{x:19,y:0}
						];
						_this.direction = "down";
					}else{
						_this.body = [
							{x:2,y:0},
							{x:1,y:0},
							{x:0,y:0}
						];
						_this.direction = "right";
					}
					_this.start_flag = false; 
					_this.speed = 300;
					_this.score_num = 3;
					_this.direction_pre = "right";	//记录上一次移动
					_this.gameover = "别走神，再来一波~";
					_this.display();
					_this.food();
					_this.score(_this.score_num);
				};
				_this.score = function (num) {	//计算分数
					if(arguments.length > 0){
						_this.score_target.html(num);
					}else {
						_this.score_target.html(++_this.score_num);
						_this.speed = Math.round(472.78*1/ Math.pow(parseInt(_this.score_target.html()),0.516));//蛇的
						switch (parseInt(_this.score_target.html())) {
							case 5: _this.upgrade("还没开始你就结束了？");break;
							case 8: _this.upgrade("相信自己，你可以更持久的~");break;
							case 13: _this.upgrade("相信自己，你可以更持久的~");break;
							case 40: _this.upgrade("定个小目标，先及格(60)！");break;
							case 60: _this.upgrade("加油~~~~你已经很牛x了！");break;
							case 80: _this.upgrade("还是人吗？？？");break;
							case 100: _this.upgrade("强无敌，突破人类极限！");break;
							case 135: _this.upgrade("快不快？");break;
							case 150: _this.upgrade("蛇太长？");break;
							case 155: _this.upgrade("蛇太长？");break;
							case 165: _this.upgrade("蛇太长？");break;
						};
					}
				};
				_this.upgrade = function (content) {	//提升难度(提高speed)，以及更新gameover提示语。
					_this.gameover = content;
					clearInterval(_this.timer);
					_this.timer = setInterval(function(){_this.run()},_this.speed);
				};
				_this.display = function() {		//根据_this.body创建蛇。
					$("#map .snake").remove();
					for(var i=0;i<_this.body.length;i++){	
						if(_this.body[i].x != null) {
							var node = "<div class='snake snake" + i +"'><div>";
							$(node).appendTo($("#map"));
							$("#map .snake" + i).css({
								top: _this.body[i].y * _this.grid,
								left: _this.body[i].x * _this.grid,
							});
						}
					};
				};
				_this.food = function () {	//随机生成食物
					$("<div class='food'><div>").appendTo($("#map"));
					_this.foodx = Math.floor(Math.random()*_this.map_x());
					_this.foody = Math.floor(Math.random()*_this.map_y());
					for (var i=0;i<_this.body.length;i++){	//避免重复，重复就重新随机一个食物。
						if(  (_this.foodx == _this.body[i].x) && (_this.foody == _this.body[i].y) && (_this.body.length < _this.map_x()*_this.map_y()-1) ) {
							return arguments.callee();
						}
					}
					var map_style = window.getComputedStyle($("#map").get(0),null);
					$("#map .food").css({
						top: _this.foody * _this.grid,
						left: _this.foodx * _this.grid
					});
				};
				_this.run = function () {	//运动，每次运动都是修改坐标再重新生成蛇。
					for(var i=_this.body.length-1;i>0;i--){	//蛇的上一节身体到下一节身体的位置（蛇头另外处理）。
						_this.body[i].x = _this.body[i-1].x;
						_this.body[i].y = _this.body[i-1].y;
					};
					switch(_this.direction) {	//蛇头移动
						case "right": _this.body[0].x +=1;break;
						case "left" : _this.body[0].x -=1;break;
						case "up": _this.body[0].y -=1;break;
						case "down" : _this.body[0].y +=1;break;
					};
					_this.direction_pre = _this.direction;	// direction_pre记录 每次头部根据snake.direction运动方向。

					//出界
					if(_this.body[0].x > _this.map_x()-1 || _this.body[0].x < 0 || _this.body[0].y > _this.map_y()-1 || _this.body[0].y < 0 ){
						alert("游戏结束1，您获得" +_this.score_num+"分，\n"+_this.gameover);
						_this.original();
					}
					//吃到自己 
					for (var j=4;j<_this.body.length;j++){
						if(  (_this.body[0].x == _this.body[j].x) && (_this.body[0].y == _this.body[j].y)  ) {
							alert("游戏结束2，您获得" +_this.score_num+"分，\n"+_this.gameover);
							_this.original();
						}
					}
					//吃到食物
					if(_this.body[0].x == _this.foodx && _this.body[0].y == _this.foody){
						_this.body.push({x:null,y:null});
						$("#map .food").remove();
						_this.food();
						_this.score();
					}
					_this.display();
				};
				_this.snake_dir = function(dir){	//判定方向
					if(_this.start_flag){
						switch (dir) {		//按键方向与上次一蛇头运动方向对比（不能与本身的对比，不然按得快就gg）。
							case "left" : 
								if(_this.direction_pre != "right"){
									_this.direction = "left";
								};break;
							case "up" : 
								if(_this.direction_pre != "down"){
									_this.direction = "up";
								};break;
							case "right" : 
								if(_this.direction_pre != "left"){
									_this.direction = "right";
								};break;
							case "down" : 
								if(_this.direction_pre != "up"){
									_this.direction = "down";
								};break;
						};
					};
				};
				_this.startOrpause = function(){	//开始或暂停
					if(!_this.start_flag){
						_this.start_flag = true;
						_this.timer = setInterval(function(){_this.run()},_this.speed);
					}else {
						_this.start_flag = false;
						clearInterval(_this.timer);
					}
				};
			};
			var snake = new Snake();
			snake.snake_init();
			$(document).keydown(function(e){
				switch (e.keyCode) {
					case 37 : 
						snake.snake_dir("left");break;
					case 38 : 
						snake.snake_dir("up");break;
					case 39 : 
						snake.snake_dir("right");break;
					case 40 : 
						snake.snake_dir("down");break;
					case 32 :
						snake.startOrpause();break;
				};
			}).click(function(e){
				var roulette_center = {x:snake.inW*parseInt($(".right").get(0).style.left)/100,y:snake.inH*parseInt($(".right").get(0).style.top)/100};
				var click_point = {x:e.clientX,y:e.clientY};
				if(tow_points(roulette_center,click_point,"s")<$("#roulette").width()*1.3/2){//轮盘
					snake.snake_dir(tow_points(roulette_center,click_point));
				}else {	//外边
					snake.startOrpause();
				}
				roulette_center = null;
				click_point = null;
			});
			function tow_points(start,end) {	//计算{x:_,y:_}两点的方向或距离
				if(arguments.length > 2){
					return Math.sqrt(Math.pow(start.y - end.y,2) + Math.pow(start.x - end.x,2),2)
				}
				var k = (start.y-end.y)/(start.x-end.x);
				if(k>1 || k<-1){
					if( end.y - start.y > 0) {return "down"}else 
					if( end.y - start.y < 0) {return "up"};
				}else if(k<1 && k>-1) {
					if( end.x - start.x > 0) {return "right"}else 
					if( end.x - start.x < 0) {return "left"};
				}
			};
			$(window).resize(function(){
				snake.snake_init();	//地图、轮盘、蛇重新初始化
			});
		});
	</script>
</head>
<body>
	<div class="center">
		<div id="map">
			<span class="scroe"></span>
		</div>
	</div>
	<div class="right">
		<div id="roulette"></div>
	</div>
</body>
</html>